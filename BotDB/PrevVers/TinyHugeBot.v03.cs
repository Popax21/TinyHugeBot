using ChessChallenge.API;
using static System.AppDomain;

class MyBot : IChessBot {
    //TinyBot_asmBuf either holds the TinyBot IChessBot instance, or the assembly buffer during decoding
    dynamic TinyBot_asmBuf = new byte[5632];
    int asmBufOff, scaleParity;
    byte scaleAccum;

    public MyBot() {
        //Decode the assembly
        //The assembly is encoded in a semi-RLE-like format
        //There are two types of tokens:
        // - scaling factors 0-15: regular tokens
        //   - the decimal integer number encodes 12 bytes, which are copied to the assembly buffer
        //   - the decimal scaling factor encodes an additional 4 bits - two regular tokens are paired up, and their scaling factors are combined to form an extra byte
        // - scaling factor 16: skip tokens (can skip up to 255 bytes forward to efficiently encode a stretch of zero bytes)
        //   - the lowest byte of the decimal integer number contains the amount of bytes to skip forward by
        //   - the remaining 11 integer number bytes are copied to the assembly buffer
        //   - skip tokens are invisible to the scalar accumulator; they don't contribute their scale value, nor do they affect parity
        // - the sign bit is unused as a minus sign would require an extra token
        foreach(decimal dec in new[] {
//>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>> BEGIN ENCODED ASSEMBLY <<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<
            73786.976307732568653M,19807040628566.084401472995583M,31105283551.3167525259001891M,731864020480M,87917195767245900480736M,7737125245.5336267181203469M,73786978493861462528M,2659636803.1521841843536900M,41277563240262130762296328704M,7555786.3725983042899970M,1152921504606846992M,0.0000309237645936M,2250679865.7484789535485444M,9444732987729522983424M,0.0000412316868620M,1766165100.6222642312136857M,1099512021504M,944473.2966838802055477M,4M,73786976307723108354M,87045502973448454175457.28000M,124085333383021748944363256.65M,16789879495129.635880082618427M,3888968924959510842698.2699M,3735675636922410275.963688542M,2177299105698750064379298062M,5283081630183919098748.733445M,291860772327160308264762.82646M,3733210358562882263.197569621M,1239163373025157007043593485M,3117957284568468122470.520340M,186357762937239536875903.43446M,21821441986567.55153162732342M,527580450097892736482345062.9M,8413166099380026420139796.005M,10566111111358799029824068630M,8400963041777418217469118723M,1680075490136337061656128.1048M,7133875983913357796.519663698M,4951930643180038789327097363M,12109867325574867397572.233997M,528668014773382143154238698.6M,24831762825065573766219712.08M,3724733507449964044193629444M,77565533024260.08313817863698M,56229318623922287618440573.58M,1490735876589739.9750290785079M,136427281339042715487944763.27M,9906572056525291311.975249426M,123794026965.3789889258127619M,38686835154824473983682879490M,13781762068715.6559837659136M,681110695717.5735285285126402M,47776890099346349612314827360M,259413944898.13966195735M,5444115459241240187665924M,1261413545937393210041864452M,1145215428975414184534350.4390M,30360174548264844.842389213443M,12585073499372396362375.74153M,712867286054976673.3961450840M,1605543213423407849967979608M,16492614181003573854500M,62380572317279894148100966.8M,40499014957814.08428840950368M,1390283582024300942841671480M,33599694194016587688096105472M,44372457594018312544100637188M,3302523727585352566346.4095744M,44372833741890303587299711066M,5627551610648580105965.2534272M,297219045347249909103.49204074M,66234708160073.222765884211207M,9093659716648165443672631989M,1873850592121085886.163017817M,2755397436456160459111936923.3M,1551411409019855677.945809250M,25109735582447236809263.68785M,11452154289754142187.448001049M,273439631155159889579101.39724M,114521542897541418453435.04391M,273439631155159889578933.62508M,357013923729503552.16391M,313869908250646559213598.89665M,7922700197613047369.6294425944M,792281576488708577571167951.35M,526124518540961136.7312535571M,1080829754122618223242249086M,274690836525023438494106624M,2593612.2168534218118658M,5444115459241240187665924M,1261413545937393210041864452M,1145215428975414184534350.4390M,7129498811929634.751331438851M,12585073499372396362375.74232M,233972498122613754.8459758936M,248353666443.9298800310616322M,35701392106782641969175M,2755397436456160415026743197.3M,102050813776136558640741634.5M,290395952022126516868863718.8M,5265231526875996502643202071M,2972190453472498981513254.3589M,279757715950003200300878.41679M,443728292763370862167.51810389M,273439612220713360478982.63559M,27853650728454312540907.82729M,51983810177633308178667544M,5261245222303101082394898435M,12379401834109840244054786.84M,26464709191849215577.71223041M,546052.4476223440879874M,12379401223019254541264158.82M,2727511395057227468449513824M,123794014074.5287430088164354M,123794010385658435727976451.1M,43714904141594654749785.991946M,4989265382563462051652435.975M,747121572509512708898437915.93M,156244354649889096474431M,31057439705591616035379740928M,328333250600232854728149073.81M,358985431752163797157330.026M,1844.6744074264708610M,12682988347505452996658676771M,996827160471142.4M,1138680618182897225953280M,667327052496553333080776992M,1844.6744074264774146M,320517637641881855358681635M,9903520333387311818516668416M,328333345047562523100546337.48M,1119795759432883421315.072M,9903520331297.641591414661120M,15629969488211.4519433216M,0.0038482906972418M,69751751028776003338.08M,2606746298958697480585585M,0.038938561086976M,9903520336846076332337537087M,2606746298900423364313374M,10831975343819134999407434246M,308429560.9126939105685510M,12379400439412015696788201472M,99682716550430.72M,3022904844849680962547712M,667327052611958073532252960M,1844.6744074264970754M,1540323789355188610026962979M,9903520405661078638627463168M,328333486718557009189902758.93M,977842114598134659615293.440M,1844.6744074265036290M,12641884868509845451708563491M,39031582296795027633269506.048M,3094851492552106868515799.07M,264210738061241832162312.27724M,27262523295046251115959555848M,529219706234047044.90218069767M,123794021431.4404364970624003M,12681234824758275913745410M,9916039679000611267829236740M,67159456057131.713673864151296M,34164243664794.84452171948047M,7132766412256380875213705731M,3961408124102729.6529313956610M,5906991115243898405326558729M,123914896514215015805869.17163M,1332238645795492477178111591.0M,221475715630695546991299918.5M,261008975002.1402047951276546M,2435027.8939376066365954M,13323987451158775753.410179338M,1683665372577830.43459645696M,5284328612265985157631491M,11461226334392188472918021M,49492761279700711441408M,1261350500981826604728.4786M,3094850309126919135207098880M,30948499368213725.2136516354M,99954319361253765413031361.06M,2953042627336.0099192645287683M,328817216070395.21264379827715M,9995433267323564715464878431M,38733164213185906563089152M,24178539479057956989831.68M,96461144105858.55393991889168M,6812289472735.206420525945623M,68122876300978.35599214482177M,13937786221963255422121083390M,16296924062182985085037.334M,456615787870873459484402.65728M,8084075614429472377.863M,682206048623176894070443216.1M,1027790415634962488239527.436M,15031329270562653782611473M,1237940103707984489604387594M,4777684788513166957597845132.6M,373442415969233900420760578.3M,527584363574562980409586547.0M,6164202754601685976906.1971729M,546579026690079246075134516.9M,9418363196011377088981.46334M,1208817520.196535885762159M,241785164095.4431469519103M,309485038291.9506156426844162M,7158102038587086659190263919M,3437955057350.1206748551194883M,5278406690204.048239018770432M,5987809584562798776366342411M,71218437453227711.67846012675M,34380764221903391267578736406M,58717578975.399010500608M,31069867652652681463018778.6M,13732268979913194351988250.129M,435339413837685438734749315.9M,7555786374364843084161.7M,2029141849359133.68320M,52782511312879916608.46320403M,13732268979768976797797801745M,102240887182396999.17420367905M,527463471770202421989684022.1M,744830566827702527871335682.3M,5909375876961864303798071838M,6006416301026475.472419556113M,37344857668082230463458.22483M,68160941175920.408877146M,9954389959787493019431021834M,78871534119844818212632920065M,3725909376300829520896729103M,2214761879028935673546932.754M,67341890519.5084280364861954M,221758561473830621099223.7078M,590755013.689169936416M,18617457631779013594604776.95M,10265107554629440243291389951M,643385115819926771507594245M,1905385483280447226784908.548M,1676429747421.8335332379002370M,12391489651421524670313270782M,6808679918920796577194.442752M,12410912744542045573178459432M,80672525128939357748431.42144M,2214752139435760822812629015M,5906877667734853114427214336M,1733850423607019177.6137224196M,243501393102118.22780416M,5273334426487293974677647626M,125534203998144207409447.8380M,29072650284324029880599M,14551873462964787645872.804709M,4440493224697855376474964504M,21898417290173344808206.56151M,446140851104078243322532355M,6248980193241366395567931648M,6233635663414239752423185M,8724836660000271265230628874M,15703946765729266692284106.41M,15703946581261825.64883796258M,5578064124006461637814129431M,27950364948978635183415642.00M,30351439976252997866680.839889M,38069477238578735864057176070M,295292267922731688262.50559501M,835610559672213864.0420505102M,309605902413.6931854866449923M,309485037563800248327930626M,20515864332775267188680524.038M,22136092888451.4684929M,1055009642529491.529268M,1083197539144920465981.7808640M,257295682190078.97412930240512M,1540171494189164456646898292M,464847304749394457331712M,4323935.2289071764341253M,1844.6768263821130242M,239807672971109072914M,3094850111904393554.62189056M,944473.2972336360194307M,9444732966838802055936M,866644919086.2855503240757509M,33856305524348090520502278M,33858722047822820238032906M,309616291710450576.4928591872M,3096649350612027676049803264M,12094386421398123455054334M,12094386391280300947013.794M,48589193767633773250056623617M,6499232431931226533532888321M,39125021787947286M,195535937541713487462.5M,65168657465360330942284.8M,18259615583134306246535944448M,76162326650921540151935027M,85833733206994187274158.099M,15784089678375151279682879.489M,928828096416185207939399681M,1417199.9365554713412611M,18815703443506716672083M,542127679.4393046254916354M,685687620.5194214492902147M,816024935.4457440478860035M,1118256390.3514910144336643M,1212703720.0093235638298115M,464680869.1237608811955715M,1747275605.8724765259040259M,649919465105.3323652618556163M,41162526339200761386447685888M,182548665763566162831998996M,20552046994328124408286414.8M,3497243420718032644664517.8880M,5262132992398078654883651584M,155955046313236306889540100M,205552069745.33396991771083M,7829978777461466486140.2058753M,64063477328813276234569006080M,425541906976707955065880792M,6870649388125.8055567828583170M,1856910101009855965672047104M,9671406734809248743555680M,42950.00068M,0.0001099511654918M,43.2345564227591175M,0.0000000000032521M,60689279440553590492389.744M,15305521689371591295261100.373M,31389061792901532506424.623872M,23661574410251757189075.396462M,202500331083858574637140.79079M,21973910043913514160399.281260M,301547016579700654802579.82580M,30146091474887333118790.886514M,33861353113693829.427295577452M,31389024253274330201366021733M,32636683050820492327910603091M,31393958646929414350956422509M,37527477163703072085062213974M,30124577330038557225701.631348M,122660800191630.125756867957M,26119392071712808799764.243815M,36653787601940.530203779821389M,35718225355930554749719.871589M,326294055170965152662352.32099M,36025301827633847131246.192494M,259972479517414806585.31469568M,31398567880612308544524.282216M,3135766232795289.1246815040256M,32636659404193820312967.669104M,133507968135.653063024509038M,30761662496960632333716.972903M,32288464898355.210036641490030M,35403909308322135249161319273M,35416031513496887999287550766M,3139031286536382166811.4977536M,254338980025115367415797113.37M,32631842513414213826822.565493M,20426555590638842.905707639397M,35724284097586128143831233641M,31393897567670687818188748114M,3138250749836071904937.3021042M,3355177845029543216104651.2479M,36033797548759953414132559465M,31343821872987900389047681865M,22592955640433322322142.253172M,301584030522362.24182096589929M,3571825350609801596942.0443769M,341401131074714227869859.1563M,1864192188647214827300324877M,5581695605216732189126.819843M,4961469490783267532597889805M,495788536169032879145.4326787M,632405687675512800541869329M,5577998121388947774546.248456M,19020684502417774347021M,2797492273894875985116334337M,619003187467259438708884743M,248556578171775079821509659.4M,1567982489314989520432661256M,6518532780930999561677.242912M,23045169190682022209729809M,3736387464509121015.50530563M,9907156538781548086443902225M,2477089078338655374444332555M,348194289175289952525616907M,37363874666990409160976104.1M,2489216078918536363866850577M,21761185694903158.45386832651M,5570589819912M
//>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>  END ENCODED ASSEMBLY  <<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<
        }) {
            //Get the bits of the decimal
            var bits = decimal.GetBits(dec);

            //Skip forward if the highest scalar bit is set
            dynamic idx = bits[3] >> 16; //16 for skip tokens, <16 otherwise
            if(idx == 16) asmBufOff += (byte) bits[0];
            else {
                //Accumulate two 4 bit scales, then add to the buffer
                //Note that for even parity tokens, the byte we write here is immediately overwritten again 
                scaleAccum <<= 4;
                TinyBot_asmBuf[asmBufOff++] = scaleAccum |= idx;
                asmBufOff -= scaleParity ^= 1;
            }

            //Add the 88/96 bits of the integer number to the buffer
            idx >>= 4; //1 for skip tokens, 0 otherwise
            while(idx < 12) TinyBot_asmBuf[asmBufOff++] = (byte) (bits[idx / 4] >> idx++ * 8);
        }

        //Load the tiny bot from the assembly
        //We can't just load it and be done with it, because the byte[] overload doesn't add the assembly to the regular load path
        //As such load it whenever any assembly fails to load >:)
        System.ResolveEventHandler asmResolveCB = (_, _) => CurrentDomain.Load(TinyBot_asmBuf); //We can't use a dynamic variable for the callback because we need it to be a delegate type
        CurrentDomain.AssemblyResolve += asmResolveCB;
        TinyBot_asmBuf = CurrentDomain.CreateInstanceAndUnwrap("B", "e");
        CurrentDomain.AssemblyResolve -= asmResolveCB;
    }

    public Move Think(Board board, Timer timer) => TinyBot_asmBuf.Think(board, timer);
}